<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <meta charset="UTF-8">
    <title>Speedtest</title>
</head>
<body>
<div>
    <button id="start_btn">Test</button>
    <button id="stop_btn">Stop</button>
</div>
<pre>
    <span>Download:</span> <span id="dbps">X</span> <span>B/s</span>
    <span>Upload  :</span> <span id="ubps">X</span> <span>B/s</span>
</pre>
<script>
  var ding = false;
  var uing = false;

  var dc = 0;
  var dt = 0;
  var dbsn = 10240; // download byte size next

  var span_dbps = document.getElementById('dbps');

  function download() {
    var start_time = new Date().getTime();

    $.get('/d?b=' + dbsn, function(data, status, xhr) {
        var request_time = new Date().getTime() - start_time;

        dc = dc + 1;
        dt = dt + request_time;
        span_dbps.innerText = ((10240 * dc) / dt).toFixed(2);
      }
    );
  }

  function upload() {
    var start_time = new Date().getTime();

    var bdata = new Uint8Array(512); // generate random data
    crypto.getRandomValues(bdata);

    $.post('/u', bdata, function (data, status, xhr) {
      var request_time = new Date().getTime() - start_time;

    }, "blob")

  }

  function TestStart() {
    console.log('on test clicked');

    // ding = true;
    uing = true;

    setInterval(function () {
      if (ding) { download(); }
      if (uing) { upload(); }
      if (dc >= 50) {     // 5sn mark
        ding = false;
        uing = true;
      }
      if (dc >= 100) {    // 10sn mark
        ding = false;
        uing = false;
      }
    }, 100); // 0.1 sn intervals
  }

  function TestStop() {
    ding = false;
    uing = false;
  }

  window.onload = function () {
    console.log('onload');

    document.getElementById('start_btn').onclick = TestStart;
    document.getElementById('stop_btn').onclick = TestStop;
  }
</script>
</body>
</html>