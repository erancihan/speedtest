<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <meta charset="UTF-8">
    <title>Speedtest</title>
</head>
<body>
<div>
    <button id="dwn_btn">Download</button>
    <button id="up_btn">Upload</button>
    <button id="stop_btn">Stop</button>
</div>
<pre>
    <span>Download:</span> <span id="dbps">X</span> <span>B/s</span>
    <span>Upload  :</span> <span id="ubps">X</span> <span>B/s</span>
</pre>
<script>
  var url = 'http://speed.erancihan.xyz';
  var stop = false;

  var dc = 0;
  var di = 0;
  var dt = 0;

  var uc = 0;
  var ui = 0;
  var ut = 0;

  var bytes = 20E+6; // 1MB

  var span_dbps = document.getElementById('dbps');

  function download() {
    if (di > 5) { return; }
    di = di + 1;

    var start_time = new Date().getTime();
    $.get(url + '/d?b=' + bytes, function (data, status, xhr) {
        var request_time = new Date().getTime() - start_time;

        dc = dc + 1;
        dt = dt + request_time;
        span_dbps.innerText = ((bytes * dc) / dt).toFixed(2);
      }
    );
  }

  function upload() {
    if (ui > 5) { return; }
    ui = ui + 1;

    var start_time = new Date().getTime();
    var bdata = new Uint8Array(10240); // generate random data
    crypto.getRandomValues(bdata);

    $.post(url + '/u', bdata, function (data, status, xhr) {
      var request_time = new Date().getTime() - start_time;

      uc = uc + 1;
      ut = ut + request_time;
    }, "blob");
  }

  function DownloadTest() {
    console.log('test download');

    stop = false;
    setInterval(function () {
      if (!stop && di < 5) { download(); }
    }, 100); // 0.1sn intervals
  }

  function UploadTest() {
    console.log('test upload');

    stop = false;
    setInterval(function () {
      if (!stop && ui < 5) { upload(); }
    }, 100); // 0.1sn intervals
  }

  function TestStop() {
    stop = true;
  }

  window.onload = function () {
    console.log('onload');

    document.getElementById('up_btn').onclick   = UploadTest;
    document.getElementById('dwn_btn').onclick  = DownloadTest;
    document.getElementById('stop_btn').onclick = TestStop;
  }
</script>
</body>
</html>