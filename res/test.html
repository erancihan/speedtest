<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <title>Speedtest</title>
</head>
<body>
<div class="container mt-2">
    <div class="row mt-1">
        <div class="col">
            <p class="mb-0">Server: <span id="server"></span></p>
            <p class="mb-1">Ping: <span id="ping"></span></p>
            <button id="start" class="btn btn-primary">Start</button>
        </div>
    </div>
    <br />
    <div class="row mt-1">
        <div class="col">
<pre>
<span>Download:</span> <span id="dbps">-</span> <span>MBps</span>
<span id="dr">-</span> <span>transferred over</span> <span id="dt">-</span> <span>seconds</span>
</pre>
            <button id="dwn_btn">Download</button>
        </div>
        <div class="col">
<pre>
<span>Upload:</span> <span id="ubps">-</span> <span>MBps</span>
<span id="ur">-</span> <span>transferred over</span> <span id="ut">-</span> <span>seconds</span>
</pre>
            <button id="up_btn">Upload</button>
        </div>
    </div>
</div>
<script>
  /**
   * resources:
   * https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest
   * https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/upload
   * https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/Using_XMLHttpRequest
   *
   * */
  var url = 'http://speed.erancihan.xyz';

  var uc = 0;
  var ui = 0;
  var ut = 0;

  var bytes = 20E6; // 20MB

  var bdata = new Uint8Array(10E6);  // 10MB
  for (let i = 0; i < 10E3; i++) {
    crypto.getRandomValues(bdata.subarray(i * 1E3, (i + 1) * 1E3)); // randomize bytes
  }

  function ping() {
    var st = new Date().getTime() * 1E6;

    $.get(url + '/ping', function (data) {
      document.getElementById('ping').innerText = ((parseInt(data) - st) / 1E6).toFixed(1) + 'ms';
    });
  }

  function download() {
    var dsa = new Date().getTime();        // download start @timestamp ms
    var dest = url + '/d?b=' + bytes + '&t=' + dsa;

    var span_dbps = document.getElementById('dbps');
    var span_dr = document.getElementById('dr');   // download resources
    var span_dt = document.getElementById('dt');   // download time elapsed

    var oReq = new XMLHttpRequest();
    oReq.addEventListener('progress', dup); // download update progress
    oReq.open('GET', dest);

    function dup(oe) {                      // download update progress
      var dt = new Date().getTime() - dsa;
      var mbps = (oe.loaded * 1E-3) / dt;

      span_dbps.innerText = mbps.toFixed(2);
      span_dr.innerText = humanFileSize(oe.loaded);
      span_dt.innerText = (dt * 1E-3).toFixed(2);
    }

    oReq.send();
  }

  function upload() {
    var usa = new Date().getTime(); // upload start @timestamp ms
    var dest = url + '/u?t=' + usa;

    var span_ubps = document.getElementById('ubps');
    var span_ur = document.getElementById('ur');   // upload resources
    var span_ut = document.getElementById('ut');   // upload time elapsed

    var file = new Blob([bdata]);

    var formdata = new FormData();
    var xhr = new XMLHttpRequest();

    xhr.upload.addEventListener('progress', uup); // upload update progress
    xhr.open('POST', dest, true);

    formdata.append('start', 0);
    formdata.append('end', file.size);
    formdata.append('file', file);

    xhr.send(formdata);

    function uup(oe) {
      var ut = new Date().getTime() - usa;
      var mbps = (oe.loaded * 1E-3) / ut;

      span_ubps.innerText = mbps.toFixed(2);
      span_ur.innerText = humanFileSize(oe.loaded);
      span_ut.innerText = (ut * 1E-3).toFixed(2);
    }
  }

  function humanFileSize(bytes) {
    var thresh = 1000;
    if (Math.abs(bytes) < thresh) {
      return bytes + ' B';
    }

    var units = ['kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
    var u = -1;
    do {
      bytes /= thresh;
      ++u;
    } while (Math.abs(bytes) >= thresh && u < units.length - 1);

    return bytes.toFixed(2) + ' ' + units[u];
  }

  function DownloadTest() {
    console.log('test download');

    download();
  }

  function UploadTest() {
    console.log('test upload');

    upload();
  }

  window.onload = function () {
    console.log('onload');

    ping();

    document.getElementById('server').innerText = url;

    document.getElementById('up_btn').onclick = UploadTest;
    document.getElementById('dwn_btn').onclick = DownloadTest;
  }
</script>
</body>
</html>