<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <meta charset="UTF-8">
    <title>Speedtest</title>
</head>
<body>
<div>
    <button id="dwn_btn">Download</button>
    <button id="up_btn">Upload</button>
    <button id="stop_btn">Stop</button>
</div>
<pre>
    <span>Download:</span> <span id="dbps">X</span> <span>B/s</span>
    <span>Upload  :</span> <span id="ubps">X</span> <span>B/s</span>
</pre>
<script>
  var url = 'http://speed.erancihan.xyz';

  var ding = false;
  var uing = false;
  var stop = false;

  var dc = 0;
  var uc = 0;

  var dt = 0;
  var ut = 0;

  var bytes = 2E+6; // 2MB

  var span_dbps = document.getElementById('dbps');

  function download() {
    var start_time = new Date().getTime();

    $.ajax({
      url: url + '/d?b=' + bytes,
      type: 'GET',
      crossDomain: true,
      success: function (data, status, xhr) {
        var request_time = new Date().getTime() - start_time;

        dc = dc + 1;
        dt = dt + request_time;
        span_dbps.innerText = ((bytes * dc) / dt).toFixed(2);
      },

    });
  }

  function upload() {
    var start_time = new Date().getTime();

    var bdata = new Uint8Array(512); // generate random data
    crypto.getRandomValues(bdata);

    $.post(url + '/u', bdata, function (data, status, xhr) {
      var request_time = new Date().getTime() - start_time;

      uc = uc + 1;
      ut = ut + request_time;
    }, "blob");
  }

  function DownloadTest() {
    console.log('test download');

    stop = false;
    setInterval(function () {
      if (!stop || dc >= 50) { download(); }
      if (stop) { dc = 0; }
    }, 100); // 0.1sn intervals
  }

  function UploadTest() {
    console.log('test upload');

    stop = false;
    setInterval(function () {
      if (!stop || uc >= 50) { upload(); }
      if (stop) { uc = 0; }
    }, 100); // 0.1sn intervals
  }

  function TestStop() {
    stop = true;
  }

  window.onload = function () {
    console.log('onload');

    document.getElementById('up_btn').onclick   = UploadTest;
    document.getElementById('dwn_btn').onclick  = DownloadTest;
    document.getElementById('stop_btn').onclick = TestStop;
  }
</script>
</body>
</html>