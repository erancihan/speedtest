<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <link crossorigin="anonymous" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" rel="stylesheet">
    <meta charset="UTF-8">
    <title>Speedtest</title>
</head>
<body>
<div class="container mt-2">
    <div class="row">
        <button id="dwn_btn">Download</button>
        <button id="up_btn">Upload</button>
        <button id="stop_btn">Stop</button>
    </div>
    <div class="row mt-2">
        <div class="col">
<pre>
<span>Download:</span> <span id="dbps">X</span> <span>MBps</span>
<span id="dr">x</span> <span>transferred</span>
<span id="dt">x</span> <span>seconds</span>
</pre>
        </div>
        <div class="col">
<pre>
<span>Upload:</span> <span id="ubps">X</span> <span>B/s</span>
<span id="ur">x</span> <span>transferred</span>
<span id="ut">x</span> <span>seconds</span>
</pre>
        </div>
    </div>
</div>
<script>
  /**
   * resources:
   * https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest
   * https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/upload
   * https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/Using_XMLHttpRequest
   *
   * */
  var url = 'http://localhost:8080';

  var uc = 0;
  var ui = 0;
  var ut = 0;

  var bytes = 20E6; // 20MB

  var bdata = new Uint8Array(10 * 1024 * 1024);  // 10MB
  for (let i = 0; i < 10240; i++) {
    crypto.getRandomValues(bdata.subarray(i * 1024, (i+1)*1024)); // randomize bytes
  }

  function download() {
    var dest = url + '/d?b=' + bytes;
    var dsa = new Date().getTime();        // download start @timestamp ms

    var span_dbps = document.getElementById('dbps');
    var span_dr   = document.getElementById('dr');   // download resources
    var span_dt   = document.getElementById('dt');   // download time elapsed

    var oReq = new XMLHttpRequest();
    oReq.addEventListener('progress', dup); // download update progress
    oReq.open('GET', dest);

    function dup(oe) {                      // download update progress
      var dt = new Date().getTime() - dsa;
      var mbps = (oe.loaded * 1E-3) / dt;

      span_dbps.innerText = mbps.toFixed(2);
      span_dr.innerText   = humanFileSize(oe.loaded);
      span_dt.innerText   = (dt * 1E-3).toFixed(2);
    }

    oReq.send();
  }

  function upload() {
    var dest = url + '/u/';
    var usa = new Date().getTime(); // upload start @timestamp ms

    var span_ubps = document.getElementById('ubps');
    var span_ur = document.getElementById('ur');   // upload resources
    var span_dt = document.getElementById('ut');   // upload time elapsed

    var file = new Blob([bdata]);
    var size = file.size;
    var slice_s = 100 * 1024;
    var start = 0;

    send(file, 0, file.size);

    /*
    function loop() {
      var end = start + slice_s;
      if (size - end < 0) { end = size; }

      var s = slice(file, start, end);
      send(s, start, end);

      if (end < size) {
        start += slice_s;
        setTimeout(loop, 1);
      }
    }
    */

    function send(piece, start, end) {
      var formdata = new FormData();
      var xhr = new XMLHttpRequest();

      xhr.upload.addEventListener('progress', uup); // upload update progress
      xhr.open('POST', dest, true);

      formdata.append('start', start);
      formdata.append('end', end);
      formdata.append('file', piece);

      xhr.send(formdata);
    }

    function uup(oe) {
      console.log(oe);
    }

    // setTimeout(loop, 1);
  }

  /*
  function slice(file, start, end) {
    var slice = file.mozSlice ? file.mozSlice : file.webkitSlice ? file.webkitSlice : file.slice ? file.slice : noop;

    return slice.bind(start, end);
  }

  function noop() { }
  */

  function humanFileSize(bytes) {
    var thresh = 1024;
    if (Math.abs(bytes) < thresh) {
      return bytes + ' B';
    }

    var units = ['kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
    var u = -1;
    do {
      bytes /= thresh;
      ++u;
    } while (Math.abs(bytes) >= thresh && u < units.length - 1);

    return bytes.toFixed(2) + ' ' + units[u];
  }

  function DownloadTest() {
    console.log('test download');

    download();
  }

  function UploadTest() {
    console.log('test upload');

    upload();
  }

  function TestStop() {
    stop = true;
  }

  window.onload = function () {
    console.log('onload');

    document.getElementById('up_btn').onclick = UploadTest;
    document.getElementById('dwn_btn').onclick = DownloadTest;
    document.getElementById('stop_btn').onclick = TestStop;
  }
</script>
</body>
</html>